name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_IP }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
          
          # Add SSH keep-alive settings
          cat >> ~/.ssh/config << EOF
          Host *
            ServerAliveInterval 60
            ServerAliveCountMax 10
            TCPKeepAlive yes
          EOF

      - name: Create .env file
        run: |
          cat > .env << EOF
          EC2_IP=${{ secrets.EC2_IP }}
          BACKEND_PORT=8000
          FRONTEND_PORT=80
          EOF

      - name: Copy files to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_IP }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'venv' \
            --exclude '.venv' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude 'qdrant_data' \
            -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ./ $EC2_USER@$EC2_HOST:~/app/

      - name: Deploy on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_IP }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ServerAliveInterval=60 $EC2_USER@$EC2_HOST << 'EOF'
            cd ~/app
            
            # Stop existing containers
            docker compose down || true
            
            # Clean up old images
            docker image prune -f
            
            # Build and start services (with output to prevent timeout)
            echo "Building images... This may take several minutes..."
            docker compose build --progress=plain
            
            echo "Starting services..."
            docker compose up -d
            
            # Wait for services
            echo "Waiting for backend to be ready..."
            for i in {1..30}; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "Backend is ready!"
                break
              fi
              echo "Attempt $i: Backend not ready yet..."
              sleep 2
            done
            
            # Health checks
            echo "Running health checks..."
            curl -f http://localhost:8000/health || exit 1
            curl -f http://localhost:80 > /dev/null || exit 1
            
            echo "✅ Deployment successful!"
            docker compose ps
          EOF

      - name: Deployment summary
        run: |
          echo "✅ Deployment completed successfully!"
          echo "Frontend: http://${{ secrets.EC2_IP }}"
          echo "Backend API: http://${{ secrets.EC2_IP }}:8000"
          echo "API Docs: http://${{ secrets.EC2_IP }}:8000/docs"
          echo "Qdrant Dashboard: http://${{ secrets.EC2_IP }}:6333/dashboard"
