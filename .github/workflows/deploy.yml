name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/mlops-backend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/mlops-backend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/mlops-backend:buildcache,mode=max

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/mlops-frontend:latest

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_IP }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

      - name: Create docker-compose for EC2
        run: |
          cat > docker-compose.prod.yml << 'EOF'
          services:
            qdrant:
              image: qdrant/qdrant:latest
              container_name: qdrant
              ports:
                - "6333:6333"
                - "6334:6334"
              volumes:
                - qdrant_data:/qdrant/storage
              networks:
                - rag-network

            backend:
              image: ${{ secrets.DOCKER_USERNAME }}/mlops-backend:latest
              container_name: rag-backend
              ports:
                - "8000:8000"
              environment:
                - QDRANT_HOST=qdrant
                - QDRANT_PORT=6333
                - QDRANT_USE_LOCAL=false
              depends_on:
                - qdrant
              volumes:
                - ./data:/app/data
              networks:
                - rag-network
              restart: on-failure

            frontend:
              image: ${{ secrets.DOCKER_USERNAME }}/mlops-frontend:latest
              container_name: rag-frontend
              ports:
                - "80:8501"
              environment:
                - API_BASE_URL=http://${{ secrets.EC2_IP }}:8000
              depends_on:
                - backend
              networks:
                - rag-network

          volumes:
            qdrant_data:

          networks:
            rag-network:
              driver: bridge
          EOF

      - name: Copy compose file to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_IP }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no docker-compose.prod.yml $EC2_USER@$EC2_HOST:~/app/docker-compose.yml

      - name: Deploy on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_IP }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
            cd ~/app
            docker compose pull
            docker compose down
            docker compose up -d
            
            echo "Waiting for backend..."
            for i in {1..30}; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "✅ Backend ready!"
                break
              fi
              sleep 2
            done
            
            curl -f http://localhost:8000/health || exit 1
            echo "✅ Deployment successful!"
            docker compose ps
          EOF

      - name: Summary
        run: |
          echo "✅ Deployed!"
          echo "Frontend: http://${{ secrets.EC2_IP }}"
          echo "Backend: http://${{ secrets.EC2_IP }}:8000/docs"
